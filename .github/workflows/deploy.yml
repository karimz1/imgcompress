name: Deployment for imgcompress to Docker Hub

on:
  push:
    branches:
      - main
    tags:
      - release_*
  workflow_dispatch:
  repository_dispatch:
    types: [ deploy ]

jobs:
  deploy-image-to-dockerhub:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tags
        id: tags
        shell: bash
        run: |
          IMAGE="karimz1/imgcompress"
          TAGS=("$IMAGE:latest")
          VERSION=""

          # If this is a release tag like refs/tags/release_1.0.3
          if [[ "${GITHUB_REF:-}" == refs/tags/release_* ]]; then
            VERSION="${GITHUB_REF#refs/tags/release_}"
            TAGS+=("$IMAGE:${VERSION}")
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          printf 'tags=%s\n' "$(IFS=,; echo "${TAGS[*]}")" >> "$GITHUB_OUTPUT"


      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  update-dockerhub-description:
    needs: deploy-image-to-dockerhub
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/release_')
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Choose README ref
        id: readme-ref
        shell: bash
        run: |
          if [[ "${GITHUB_REF:-}" == refs/tags/release_* ]]; then
            README_REF="${GITHUB_REF#refs/tags/}"
          else
            README_REF="main"
          fi
          echo "README_REF=$README_REF" >> "$GITHUB_ENV"

      - name: Update Docker Hub Description
        run: |
          python update_dockerhub_description.py \
              --readme ReadMe.md \
              --branch "$README_REF" \
              --base-url "https://raw.githubusercontent.com/karimz1/imgcompress/$README_REF"
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPO: "imgcompress"

