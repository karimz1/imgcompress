name: Deployment for imgcompress to Docker Hub

on:
  push:
    branches:
      - main
    tags:
      - release_*
  workflow_dispatch:
  repository_dispatch:
    types: [ deploy ]

jobs:
  deploy-image-to-dockerhub:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # needed for pushing to GHCR with GITHUB_TOKEN
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tags
        id: tags
        shell: bash
        env:
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail

          # Docker Hub image
          IMAGE_DH="karimz1/imgcompress"

          # GitHub Container Registry image
          IMAGE_GH="ghcr.io/${GITHUB_OWNER}/imgcompress"

          TAGS=()
          VERSION=""

          # If this is a release tag like refs/tags/release_1.0.3
          if [[ "${GITHUB_REF:-}" == refs/tags/release_* ]]; then
            VERSION="${GITHUB_REF#refs/tags/release_}"

            # For releases: versioned tag + latest (both registries)
            TAGS+=("$IMAGE_DH:${VERSION}")
            TAGS+=("$IMAGE_DH:latest")
            
            TAGS+=("$IMAGE_GH:${VERSION}")
            TAGS+=("$IMAGE_GH:latest")
          else
            # Main (or other branches): nightly (both registries)
            TAGS+=("$IMAGE_DH:nightly")
            TAGS+=("$IMAGE_GH:nightly")
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          printf 'tags=%s\n' "$(IFS=,; echo "${TAGS[*]}")" >> "$GITHUB_OUTPUT"

      - name: Debug - Display Computed Tags
        shell: bash
        env:
          TAGS_OUTPUT: ${{ steps.tags.outputs.tags }}
          VERSION_OUTPUT: ${{ env.VERSION }}
        run: |
          echo "::group::üè∑Ô∏è Computed Docker Image Tags"
          echo "VERSION: $VERSION_OUTPUT"
          echo ""
          echo "Tags that will be pushed:"
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS_OUTPUT"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "  ‚Ä¢ $tag"
          done
          echo "::endgroup::"

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha,scope=app-deploy
          cache-to: type=gha,mode=max,scope=app-deploy

  update-dockerhub-description:
    needs: deploy-image-to-dockerhub
    if: startsWith(github.ref, 'refs/tags/release_')
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Choose README ref
        id: readme-ref
        shell: bash
        run: |
          README_REF="${GITHUB_REF#refs/tags/}"
          echo "README_REF=$README_REF" >> "$GITHUB_ENV"

      - name: Update Docker Hub Description
        run: |
          python update_dockerhub_description.py \
              --readme ReadMe.md \
              --branch "$README_REF" \
              --base-url "https://raw.githubusercontent.com/karimz1/imgcompress/$README_REF"
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPO: "imgcompress"